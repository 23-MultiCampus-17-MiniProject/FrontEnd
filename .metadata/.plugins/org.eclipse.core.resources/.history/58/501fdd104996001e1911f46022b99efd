onload = function() {
	
	
	
//**********************************구분선**********************************************//
//**********************************구분선**********************************************//

	let login_user = {
		id: "Test_ID",
		comments_like:[],
		my_idx: -1
	}
	
	var serial_num = 0; // Comments 각 객체들의 고유한 번호
	
	function Comments(id, comments, movie_title, score){
		
		this.serial_num = serial_num++;
		this.id = id;
		this.date = new Date();
		this.like = 0;
		this.comments = comments;
		this.movie_title = movie_title;
		this.score = score;
	}
	
	let comments_obj_arr=[];
	
	function dummy_comments_create(num){
		for(let i = 0; i<num; i++){
			comments_obj_arr.push(new Comments("랜덤아이디"+i,"랜덤코멘트"+"랜덤코멘트"+"랜덤코멘트"+"랜덤코멘트"+i,"영화제목", parseInt(Math.random()*5)));
		}
		
	}
	dummy_comments_create(20);
	
	//하나의 한줄평 게시물 생성
	//한줄평 게시물이 가진 유저아이디가 로그인한 유저의 아이디와 일치하는 경우
		//그 게시물에만 수정 삭제 태그들을 넣어주고 숨김처리
		//좋아요 id엔 게시물의 객체배열의 인덱스, title엔 고유번호 넣어줌으로써
		//수정 삭제시엔 객체배열의 인덱스 사용해서 빠르게 삭제
		//좋아요 클릭시 고유번호와 로그인 유저의 프로퍼티에 존재하는 좋아요 누른 게시물의 고유번호 대조
		//인덱스는 삭제 생성등의 일이 있을 때 재랜더링하면서 다시 설정
	let movie_comments_list = document.getElementById("movie_comments_list");
	function comments_list_create(comments_obj_parameter, idx) {
			let my_comment_modify_part = "";
			
			if(comments_obj_parameter.id == login_user.id){
				login_user.my_idx = idx;
				
				my_comment_modify_part = `
					<div id="my_comment_modify_part" style="display: inline-block">
						<button id="my_comments_modify_btn">수정</button>
						<button id="my_comments_delete">삭제</button>
					</div>`
			}
			
			movie_comments_list.innerHTML += `
				<div class="comments" >
					<div>
						<div class="comments_id" style="display: inline-block">
							${comments_obj_parameter.id}
						</div>
						<span>
							평점 ${comments_obj_parameter.score}
						</span>
						<div class="like_btn" style="display: inline-block">
							<img src="resources/images/like.png"  id='${idx}' title='${comments_obj_parameter.serial_num}'> ${comments_obj_parameter.like}
						</div>
					</div>
					
					<div>
						<div class="comments_date" style="display: inline-block">
							${comments_obj_parameter.date.toLocaleString()}
						</div>
						
						${my_comment_modify_part}
					</div>
					<div class="comments_contents">
						${comments_obj_parameter.comments}
					</div>
				</div>`;
	}
	//리뷰 게시물 하나 만드는 메서드를 코멘트 객체 배열의 크기만큼 반복문
	function render_comments_list(){
		for(let i = 0; i < comments_obj_arr.length; i++){
			comments_list_create(comments_obj_arr[i], i);
		}
	}
	
	//수정 삭제 추가 등의 이벤트가 생길 때 모두 지우고 다시 랜더링+이벤트등록
	function re_render_comments_list(){
		//리스트 전부 지우고 새로 불러오기
		movie_comments_list.innerHTML = "";
		render_comments_list();
		//좋아요 이벤트 코멘트 읽고쓰는 이벤트 다시 등록해주기
		like_add_event();
		//my_idx 값이 -1인데도 쓰려고하면 오류가 나옴 => if
		if(login_user.my_idx != -1){
			comments_CD();
		}
		
	}
	
	//최초 게시물의 생성 및 이벤트 등록
	render_comments_list();
	like_add_event();
	if(login_user.my_idx != -1){
			comments_CD();
		}
		
	//글쓰기
	let comments_score = document.querySelector("#write_comments > select");
	let write_btn = document.getElementById("write_btn");
	let writing_commentbox = document.querySelector("#writing_commentbox");
	write_btn.addEventListener("click",function () {
		console.log("write_btn 동작")
		if(login_user.my_idx >= 0 && modify_btn == false){
			alert("한줄평을 이미 작성하셨습니다");
		}else if(modify_btn){
			alert("수정되었습니다");
			comments_obj_arr[login_user.my_idx].comments = writing_commentbox.value;
			comments_obj_arr[login_user.my_idx].score = click_star_idx;
			modify_btn = false;
			re_render_comments_list();
			clear_write_comments();
		
		}else{
			alert("완료되었습니다");
			comments_obj_arr.push(
				new Comments(login_user.id,
				writing_commentbox.value,
				receive_data, click_star_idx));
				//receive_data: 이 페이지로 받아온 영화제목
			
			re_render_comments_list();
			//한줄평 쓰는 곳 + 평점 다시 초기화
			clear_write_comments();
			
			//글쓰기 후 코멘트 객체 배열의 마지막 인덱스를 my_idx로 설정
			login_user.my_idx = comments_obj_arr.length - 1;
		}
	});
	
	function clear_write_comments(){
		write_btn.innerHTML = "쓰기";
		writing_commentbox.value = ""
		click_star_idx = 0;
		re_rendering_star();
		addEvent();
		addClickEvent();
	}
	
	//수정 및 삭제 버튼의 이벤트 처리
	let modify_btn = false;
	function comments_CD(){
		let my_comments_modify_btn = document.getElementById("my_comments_modify_btn");
		
		
		my_comments_modify_btn.addEventListener("click", function () {
			//숨겨져 있던 input 드러내기 및 수정버튼 숨기기
			my_comments_modify_btn.style = 'visibility: hidden';
			//
			click_star_idx =  comments_obj_arr[login_user.my_idx].score;
			modify_btn = true;
			write_btn.innerHTML = "수정";
			writing_commentbox.value = comments_obj_arr[login_user.my_idx].comments;
			removeDarken();
			window.scrollTo(0, 300);
		});
		
			//삭제 버튼의 이벤트 처리
		document.getElementById("my_comments_delete").addEventListener("click", () => {

			if (confirm("삭제하시겠습니까?") == true) {
				alert("삭제되었습니다");
				comments_obj_arr.splice(login_user.my_idx, 1);
				login_user.my_idx = -1;
				re_render_comments_list();
				modify_btn = false;
				clear_write_comments();
				
			}
		});
	}
	
	//좋아요 +1 한 사람당 한번씩만 줄 수 있게
	function like_add_event(){
		let like_btn = document.querySelectorAll(".like_btn");
		for(let i = 0; i < like_btn.length; i++){
			like_btn[i].addEventListener("click", function(e){
				let target_serial_num = e.target.getAttribute("title");
				let target_idx_num = e.target.getAttribute("id");
				let flg = true;
				
				//내가 준 코멘트의 고유번호와 이벤트가 발생한 코멘트 객체의 고유번호 대조
				for(let j =0; j < login_user.comments_like.length; j++){
					if(target_serial_num == login_user.comments_like[j]){
						flg = false;
						alert("좋아요는 게시물 당 한번만 가능합니다");
						break;
					}
				}
				
				if(flg == true){
					comments_obj_arr[target_idx_num].like += 1;
					login_user.comments_like.push(comments_obj_arr[target_idx_num].serial_num);
					re_render_comments_list()
				}
			
			});
		}
	}

	//******************************    정렬 part   ****************************************//
	//정렬
	let sort_date_btn = document.getElementById("sort_date_btn");
	let sort_like_btn = document.getElementById("sort_like_btn");
			
	let sort_date_swicth = true;
	let sort_like_swicth = true;
	
	//시간 순으로 정렬
	function sort_date(){
		if(sort_date_swicth){
			comments_obj_arr.sort((a,b) => a.date - b.date);
			sort_date_swicth = !sort_date_swicth;
		}else{
			comments_obj_arr.sort((a,b) => b.date - a.date);
			sort_date_swicth = !sort_date_swicth;
		}	
	}
	
	function sort_like(){
		if(sort_date_swicth){
			comments_obj_arr.sort((a,b) => a.like - b.like);
			sort_date_swicth = !sort_date_swicth;
		}else{
			comments_obj_arr.sort((a,b) => b.like - a.like);
			sort_date_swicth = !sort_date_swicth;
		}	
	}
	sort_date_btn.onclick = ()=>{
		sort_date();
		re_render_comments_list();
		console.log("작동");
	}
	sort_like_btn.onclick = ()=>{
		sort_like();
		re_render_comments_list();
		console.log("작동");
	}
			
	//******************************   평점 스크립트   ****************************************//
		let stars = document.querySelectorAll(".stars");
		let click_star_idx = 0;
		
		function addEvent(start){
			stars = document.querySelectorAll(".stars");
			if(start == null){
				start = 0;
			}
			for(let i = start; i < stars.length; i++){
				stars[i].addEventListener("mouseenter", () =>  lightenStar(i));
				stars[i].addEventListener("mouseleave", () => darkenStar(start, i));
			}
			
		}
		
		function addClickEvent(){
			
			stars = document.querySelectorAll(".stars");
			for(let i = 0; i < stars.length; i++){
				stars[i].addEventListener("click", () => {
					if(click_star_idx == stars[i].value){
						re_rendering_star();
						click_star_idx = 0;
						addEvent();
						addClickEvent();
					}else{
						click_star_idx = stars[i].value;
						removeDarken();
					}
				});
			}
		}
		
		function lightenStar(end){
			
			for(let j = 0; j <= end; j++){
				stars[j].style.content = "url(resources/images/1star.png)";
			}
		}
		
		function darkenStar(start, end){
		
			for(let j = start; j <= end; j++){
				stars[j].style.content = "url(resources/images/1emptystar.png)";
			}
		}
	
		function removeDarken(){
			
			re_rendering_star();
			stars = document.querySelectorAll(".stars");
			lightenStar(click_star_idx - 1);
			addEvent(click_star_idx);
			addClickEvent();
		}
		
		function re_rendering_star(){
			let rating_star = document.getElementById("rating_star");
			
			rating_star.innerHTML = "";
			rating_star.innerHTML = `
					<input type="radio" name="rating" id="1star" value="1" class="stars">
					<input type="radio" name="rating" id="2star" value="2" class="stars">
					<input type="radio" name="rating" id="3star" value="3" class="stars">
					<input type="radio" name="rating" id="4star" value="4" class="stars">
					<input type="radio" name="rating" id="5star" value="5" class="stars">`
		}
		
		addEvent();
		addClickEvent();		
			
}