package com.mc.multicinema;

import java.io.BufferedInputStream;
import java.net.URL;
import java.util.ArrayList;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class MovieServiceImpl implements MovieService{
	
	@Autowired
	DailyBoxOfficeDTO dto;

	public ArrayList<DailyBoxOfficeDTO> dailyBoxOffice(){
		
		ArrayList<DailyBoxOfficeDTO> list = new ArrayList<>();
		try {
			JSONParser jsonparser = new JSONParser();
	        
			JSONObject jsonobject = (JSONObject)jsonparser.parse(readBoxOfficeUrl());
			JSONObject json =  (JSONObject) jsonobject.get("boxOfficeResult");
	        JSONArray array = (JSONArray)json.get("dailyBoxOfficeList");
	        
	        System.out.println(array.size());
	        for(int i = 0 ; i < array.size(); i++){
	            
	            JSONObject entity = (JSONObject)array.get(i);
	            String movieNm = (String) entity.get("movieNm");
	            String movieCd = (String) entity.get("movieCd");
	            String rank = (String) entity.get("rank"); 
	            
	            DailyBoxOfficeDTO tmp = (DailyBoxOfficeDTO)dto.clone();
	            
	            tmp.setMovieNm(movieNm);
	            tmp.setMovieCd(movieCd);
	            tmp.setRank(rank);
	            
	            list.add(tmp);
	        }
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
        
        return list;
        
   }
   private static String readBoxOfficeUrl() throws Exception {
       BufferedInputStream reader = null;
       String key = "f0b5971de85c22ab8010d759968eef23";
       String targetDt = "";
       try {
           URL url = new URL(
                   "http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/"
                   + "searchDailyBoxOfficeList.json"
                   + "?"
                   + "key="+key
                   + "&targetDt=20231207");
           reader = new BufferedInputStream(url.openStream());
           StringBuffer buffer = new StringBuffer();
           int i;
           byte[] b = new byte[4096];
           while( (i = reader.read(b)) != -1){
             buffer.append(new String(b, 0, i));
           }
           return buffer.toString();
       } finally {
           if (reader != null)
               reader.close();
       }
   }
   
   private static String readMovieInfoUrl(String movieCd) throws Exception {
       BufferedInputStream reader = null;
       String key = "f0b5971de85c22ab8010d759968eef23";
       try {
           URL url = new URL(
                   "http://www.kobis.or.kr/kobisopenapi/webservice/rest/movie/searchMovieInfo.json"
                   + "?"
                   + "key="+key
                   + "&movieCd=" + movieCd);
           reader = new BufferedInputStream(url.openStream());
           StringBuffer buffer = new StringBuffer();
           int i;
           byte[] b = new byte[4096];
           while( (i = reader.read(b)) != -1){
             buffer.append(new String(b, 0, i));
           }
           return buffer.toString();
       } finally {
           if (reader != null)
               reader.close();
       }
   }
   
}

