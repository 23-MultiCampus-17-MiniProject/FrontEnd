<%@page import="java.util.ArrayList"%>
<%@page import="com.mc.multicinema.moviecomment.dto.MovieCommentDTO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    <%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MultiCinema</title>
<script src="resources/js/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" type="text/css" href="resources/css/movie_detail.css">
<script src="resources/js/movie_detail.js"></script>
<script>

$(document).ready(function(){
	$("#write_btn").on('click', function(e){
		
		if("${login_user_id}" == ""){
			if(confirm("한줄평은 로그인 후 등록 가능합니다. 로그인하시겠습니까?") == true){
				e.preventDefault();
				location.href = "login";//이 부분은 나중에 확인 확인이든 취소든 뭘 눌러도 오류뜸 왜?
			}
		}else{
			e.submit();
		}
	});
	
let movie_comments_list = document.getElementById("movie_comments_list");
	
	add_comment_event();
	
	//좋아요 +1 한 사람당 한번씩만 줄 수 있게
	//로그인 안한 사람이 누르면 로그인 화면으로보내기
	//ajax 활용
	//클릭하면 일단 comment_num, user_key 들고가서 대조
	//select * from user_like_movie_comment where comment_num and user_key
	//null이면 db에 user_like_movie_comment(moviecomment_like에 +1) + movie_comment 테이블에 들고가기
	//결과값이 있다 불가능
	//comment num는 propagation 활용 해봅시다
	//comment num을 이용해 queryselector("#comment_num .좋아요") + 1 해주고 끝
	
	//더보기 버튼 구현 시를 위해 반복문 시작과 끝 지정해서 이벤트를 중복 지정하지 않게
	
	function add_comment_event(){
		let like_btn = document.querySelectorAll(".like_btn");
		let comments = document.querySelectorAll(".comments");
		let click_comment_num = 0;
		let my_comments_modify_btn = $("#my_comments_modify_btn");
		let modify_btn_click = false;
		let like_btn_click = false;
		let my_comments_delete_btn = $("#my_comments_delete_btn");
		let my_comments_modify_cancel_btn = $("#my_comments_modify_cancel_btn");
		let updateform = $("#updateform");
		let delete_btn_click = false;

		
		my_comments_modify_btn.on("click", function (e) {
			// 수정버튼 숨기기, 삭제버튼 숨기기
			my_comments_modify_btn.attr("style", "display:none");
			my_comments_delete_btn.attr("style", "display:none");
			//
			modify_btn_click = true;
			//따로 text 생기는거 구현 + submit 동작할 버튼 구성
			updateform.attr("style", "display:inline-block");
			my_comments_modify_cancel_btn.attr("style", "display:inline-block");
		});
		
		my_comments_modify_cancel_btn.on("click", function(){
			//수정 취소 기능
			my_comments_modify_btn.attr("style", "display:inline-block");
			my_comments_delete_btn.attr("style", "display:inline-block");
			//
			modify_btn_click = true;
			
			updateform.attr("style", "display:none");
			my_comments_modify_cancel_btn.attr("style", "display:none");
		});
		
		
		my_comments_delete_btn.on("click", (e) => {
			if (confirm("삭제하시겠습니까?") == true) {
				delete_btn_click = true;
				e.submit();
			}else{
				e.preventDefault();
			}
		});
		
		for(let i = 0; i < comments.length; i++){
			
			like_btn[i].addEventListener("click", function(e){
				//여기서 바로 ajax 사용하면 click_comment_num값이 안넘어옴 
  				//=> 좋아요 버튼 클릭 여부 확인 + 로그인 여부
				if("${login_user_id}" == ""){
					if(confirm("좋아요는 로그인 후 등록 가능합니다. 로그인하시겠습니까?") == true){
						location.href = "login";
					}
				}else{
					like_btn_click = true;	
				}
  				 
				console.log("like btn");
			});
			
			comments[i].addEventListener("click", function(e){
				click_comment_num = comments[i].id;
				console.log("comment div " + click_comment_num);
				
				//좋아요 버튼 클릭시
				if(like_btn_click){
					likeAdd(click_comment_num);
					like_btn_click=false;
				//수정 버튼 클릭시
				}else if(modify_btn_click){
					
					console.log("수정 작동");
					modify_btn_click = false;
					//수정 textarea에 기존에 썼던 content를 기본값으로
					let tmp = $("#" + click_comment_num + " .comments_contents").text();
					$("#updateform_content").text(tmp.trimStart());
					//평점 기본 선택
					let update_score_option = document.querySelector("#update_score").options;
					let comments_score = Number($("#" + click_comment_num + " .comment_score").text().trim());
					console.log(comments_score);
					for(let j = 0; j < update_score_option.length; j++){
						console.log(update_score_option[j].value + "/" + comments_score);
						if(update_score_option[j].value == comments_score){
							update_score_option[j].selected = true;
						}
					}
				}
			});
			
		}//for
	}
	
	function likeAdd(click_comment_num){
		$.ajax({
			url: "moviecommentlikeadd",
			data:{'comment_num': click_comment_num, 'user_key': "${login_user_key}"},
			type: 'get',
			dataType: 'json',
			success: function(response){
				//alert(JSON.stringify(response));
				//response 객체형태 -> 출력 -> 문자열형태변경메서드
				if(response.result == "좋아요 추가성공"){
					alert("추가되었습니다");
					let tmp = $("#" + click_comment_num + " .comment_like").text();
					$("#" + click_comment_num + " .comment_like").html(1 + Number(tmp));
				}else if(response.result == "중복"){
					alert("좋아요는 한줄평당 하나씩만 가능합니다");
				}
			},
			error: function(request, e){
				alert("코드=" + request.status + " 메세지=" + request.responseText + " 오류=" + e);
			}
		});
	}
	
	
	//******************************    정렬 part   ****************************************//
	//정렬
	let sort_date_btn = document.getElementById("sort_date_btn");
	let sort_like_btn = document.getElementById("sort_like_btn");
			
	let sort_date_swicth = true;
	let sort_like_swicth = true;
	
	//시간 순으로 정렬
	
	sort_date_btn.onclick = ()=>{
		sort_date();
		re_render_comments_list();
		console.log("작동");
	}
	sort_like_btn.onclick = ()=>{
		sort_like();
		re_render_comments_list();
		console.log("작동");
	}
			
	//******************************   평점 스크립트   ****************************************//
		let stars = document.querySelectorAll(".stars");
		let click_star_value = 0;
		let flg = false;
		
		function addEvent(start){
			stars = document.querySelectorAll(".stars");
			if(start == null){
				start = 0;
			}
			for(let i = start; i < stars.length; i++){
				
				stars[i].addEventListener("mouseenter", () =>  lightenStar(i));
				stars[i].addEventListener("mouseleave", () => darkenStar(start, i));
			}
		}	
		
		function addClickEvent(){
			
			stars = document.querySelectorAll(".stars");
			for(let i = 0; i < stars.length; i++){
				stars[i].addEventListener("click", (e) => {
					//같은별 클릭했을 경우
					if(click_star_value == stars[i].value){
						click_star_value = 0;
						e.target.checked = false;
					//다른 별 클릭했을 경우
					}else{
						click_star_value = stars[i].value;
						for(let j = click_star_value; j < stars.length; j++){
							stars[j].style.content = "url(resources/images/1emptystar.png)";
						}
					}
				});
			}
		}
		
		function lightenStar(end){
			
			for(let j = 0; j <= end; j++){
				stars[j].style.content = "url(resources/images/1star.png)";
			}
		}

		function darkenStar(start, end){
			
			for(let j = start; j <= end; j++){
				if(click_star_value <= j){
					stars[j].style.content = "url(resources/images/1emptystar.png)";
				}
			}
		}
		addEvent();
		addClickEvent();
		
		//******************************   더보기 이벤트   ****************************************//
		let commentsStart = 10; //moviedetail 시작시에 처음 페이지에는 몇개를 띄워줄지 정보를 넘겨받는 걸로
		$("#more_comments_btn").on("click", function(){
			let commentsCount = 10;
			$.ajax({
				url: "morecomment",
				data:{'movie_cd': "${movie_cd}", 'commentsCount': commentsCount, 'commentsStart': commentsStart},
				type: 'post',
				dataType: 'json',
				success: function(response){
					if(response == null || response.length < commentsCount){
						$("#more_comments_btn").attr("style", "display:none");
					}else{
						console.log("response.length"+response.length)
						for(let i = 0; i <= response.length; i++){
							console.log("반복문: "+i)
							$("#movie_comments_list")
							.append("<div class=\"comments\" id=\" "+response[i].comment_num +" \">")
							.append("<div>")
							.append("<div class=\"comments_id\" style=\"display: inline-block\">")
							.append(response.user_id)
							.append("</div>")
							.append("<span>평점</span>")
							.append("<span class=\"comment_score\">"+response[i].comment_score+"</span>")
							.append("<div class=\"like_btn\" style=\"display: inline-block\">")
							.append("<img src=\"resources/images/like.png\"><span class=\"comment_like\">"+response[i].comment_like+"</span></div></div>")
							.append("<div>")
							.append("<div class=\"comments_date\" style=\"display: inline-block\">")
							.append(response[i].comment_write_date + "</div>");
							
							/*if("${login_user_id}" == response[i].user_id){
								$("#movie_comments_list")
								.append("<div id=\"my_comment_modify_part\" style=\"display: inline-block\">")
								.append("<form id=\"updateform\" action=\"updatemoviecomment\" method=\"post\" style=\"display: none\">")
								.append("<input type="hidden" name="comment_num" value=\""+response[i].comment_num+"\">")
								.append("<input type=\"hidden\" name=\"movie_cd\" value=\""+response[i].movie_cd+"\">")
								.append("<select id=\"update_score\" name=\"comment_score\">")
								.append("<option value=\"0\">0")
								.append("<option value=\"1\">1")
								.append("<option value=\"2\">2")
								.append("<option value=\"3\">3")
								.append("<option value=\"4\">4")
								.append("<option value=\"5\">5")
								.append("</select>")
								.append("<textarea id=\"updateform_content\" name=\"comment_content\" ></textarea>")								
								.append("<button id=\"my_comments_modify_confirm_btn\">수정확인</button>")								
								.append("</form>")
								.append("<button id=\"my_comments_modify_cancel_btn\" style=\"display: none\">취소</button>")
								.append("<button id=\"my_comments_modify_btn\">수정</button>")
								.append("<form id=\"deleteform\" action=\"deletemoviecomment\" method=\"post\" style=\"display: inline-block\">")
								.append("<input type=\"hidden\" name=\"comment_num\" value=\""+response[i].comment_num+"\">")
								.append("<input type=\"hidden\" name=\"movie_cd\" value=\""+response[i].movie_cd+"\">")
								.append("<button id=\"my_comments_delete_btn\">삭제</button>")
								.append("</form></div>");	
							}//if end*/
							$("#movie_comments_list")
							.append("</div>")
							.append("<div class=\"comments_contents\">")
							.append(response[i].comment_content)
							.append("</div>");
	
						}//for end
					}//if-else end
				},//success end
				error: function(request, e){
					alert("코드=" + request.status + " 메세지=" + request.responseText + " 오류=" + e);
				}
			});
		})
		
		
		
		
});
</script>
<body>
<div id="headerInput"></div>
<!-- body start -->
<%
String message = (String)session.getAttribute("message");
if(message != null){
%>	
	<script>alert("${message}");</script>
<%
	session.removeAttribute("message");
}
%>
${login_user_name }
<div id="contents">
	<div id="contents_movie_detail">
		<div id="movie_datail_upper">
			<div id="movie_poster">
				<img src="resources/images/movie_poster/더_마블스.jpg" alt="더_마블스.jpg">
			</div>
			<div id="movie_info">
				<div id="movie_info_title">
					<h1>더 마블스</h1>
				</div>
				<div>
					<h4>감독: 김민성</h4>
					<h4>배우: 김민성,김민성,김민성,김민성,김민성</h4>
					<h4><span>드라마</span><span>대한민국</span><span>130분</span><span>2023.10.25</span></h4>
				</div>
				<div id="movie_info_synopsis">
					<p>
					</p>
				</div>
				<div id="movie_info_ticketing">
					<a href="/ticketing.html?movie=">
						<div>예매하기</div>
					</a>
				</div>
			</div>
		</div>
		
		<div id="still_cut_list">
			<div id="still_cut_slider">
		<%for(int i=0 ; i<10; i++){ %>
			<img src="resources/images/movie_poster/더_마블스.jpg" alt="더_마블스.jpg">
		<%} %>
			</div>
		</div>
		
	</div>
	<div id="contents_movie_comments">
		<h2>한줄평</h2>
		<div id="comments_sort_btn">
			<button class = "sort_btn" id="sort_date_btn">날짜 별로 정렬</button><button class = "sort_btn" id="sort_like_btn">좋아요 순으로 정렬</button>
		</div>
		<form action="moviedetail" method="post">
		<div id="write_comments">
			<div id="rating_star">
				<input type="radio" name="comment_score" id="1star" value="1" class="stars">
				<input type="radio" name="comment_score" id="2star" value="2" class="stars">
				<input type="radio" name="comment_score" id="3star" value="3" class="stars">
				<input type="radio" name="comment_score" id="4star" value="4" class="stars">
				<input type="radio" name="comment_score" id="5star" value="5" class="stars">
			</div>
			<div>
				
			</div>
			<input id="writing_commentbox" type="text" name="comment_content" placeholder="최대 50글자를 입력해주세요" maxlength="50">
			<input type="hidden" id="movie_cd" name="movie_cd" value="${movie_cd }"><!-- 영화정보같이 -->
			<input type="hidden" id="user_key" name="user_key" value="${login_user_key }">
			<button id="write_btn">쓰기</button><!-- 버튼 이벤트 구현 -->
		</div>
		</form>
		<div id="movie_comments_list">
			
			<% ArrayList<MovieCommentDTO> commentlist= (ArrayList<MovieCommentDTO>)request.getAttribute("commentlist");
			String login_user_id = (String)session.getAttribute("login_user_id");
			if(login_user_id == null){
				login_user_id = "";
			}
			for(MovieCommentDTO dto : commentlist){ 
				//if(로그인 유저의 키 == dto.user_key)
			%>
				<div class="comments" id='<%=dto.getComment_num() %>'>
					<div>
						<div class="comments_id" style="display: inline-block">
							<%=dto.getUser_id() %>
						</div>
						<span>
							평점
						</span>
						<span class="comment_score">
							<%=dto.getComment_score() %>
						</span>
						<div class="like_btn"  style="display: inline-block">
							<img src="resources/images/like.png"  ><span class="comment_like"><%=dto.getComment_like() %></span>
						</div>
					</div>
					
					<div>
						<div class="comments_date" style="display: inline-block">
							<%=dto.getComment_write_date() %>
						</div>
						<%if(login_user_id.equals(dto.getUser_id())){
							%>
						<div id="my_comment_modify_part" style="display: inline-block">
							<form id="updateform" action="updatemoviecomment" method="post" style="display: none">
								<input type="hidden" name="comment_num" value="<%=dto.getComment_num() %>">
								<input type="hidden" name="movie_cd" value="<%=dto.getMovie_cd() %>">
								<select id="update_score" name="comment_score">
									<option value="0">0
									<option value="1">1
									<option value="2">2
									<option value="3">3
									<option value="4">4
									<option value="5">5
								</select>
								<textarea id="updateform_content" name="comment_content" ></textarea>							
								<button id="my_comments_modify_confirm_btn">수정확인</button>
							</form>
								<button id="my_comments_modify_cancel_btn" style="display: none">취소</button>
								<button id="my_comments_modify_btn">수정</button>
							<form id="deleteform" action="deletemoviecomment" method="post" style="display: inline-block">
								<input type="hidden" name="comment_num" value="<%=dto.getComment_num() %>">
								<input type="hidden" name="movie_cd" value="<%=dto.getMovie_cd() %>">
								<button id="my_comments_delete_btn">삭제</button>
							</form>
						</div>
						<%}%>
					</div>
					<div class="comments_contents">
						<%=dto.getComment_content() %>
					</div>
					
				</div>
			<%} %>
		</div>
		<button id="more_comments_btn">더보기 버튼</button>
	</div>


</div>


<!-- body end -->
<div id="footerInput"></div>
</body>




</html>